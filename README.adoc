:source-highlighter: highlight.js
:versionPlaceholder: x.y.z

= Maven Central Portal Publisher

image:https://img.shields.io/gradle-plugin-portal/v/io.github.zenhelix.maven-central-publish[Gradle Plugin Portal,link=https://plugins.gradle.org/plugin/io.github.zenhelix.maven-central-publish]

Gradle plugin for publishing to Maven Central via https://central.sonatype.org/publish/publish-portal-api/[Publisher API].

== Installation

[source,kotlin]
----
plugins {
    id("io.github.zenhelix.maven-central-publish") version "{versionPlaceholder}"
}
----

== Overview

Plugin applies `maven-publish` and `signing` plugins automatically, then extends publishing workflow with Maven Central Portal integration:

* Creates checksum files (MD5, SHA1, SHA256, SHA512) for all artifacts
* Packages artifacts, signatures, and checksums into deployment bundles (ZIP)
* Uploads bundles via Publisher API
* Polls deployment status until completion

Supports both single-module and multi-module projects with automatic aggregation.

== Configuration

[source,kotlin]
----
mavenCentralPortal {
    credentials {
        username = providers.gradleProperty("mavenCentralUsername")
        password = providers.gradleProperty("mavenCentralPassword")
    }
    publishingType = PublishingType.AUTOMATIC
    deploymentName = "my-deployment"

    uploader {
        maxStatusChecks = 20
        statusCheckDelay = Duration.ofSeconds(10)
    }
}
----

[cols="1,3"]
|===
|Property |Description

|`credentials.username`
|Maven Central username or token username

|`credentials.password`
|Maven Central password or token password

|`publishingType`
|`AUTOMATIC` - auto-publish after validation +
`USER_MANAGED` - manual publish via Portal UI +
Default: `AUTOMATIC`

|`deploymentName`
|Optional deployment identifier in Portal +
Default: `null` (auto-generated)

|`uploader.maxStatusChecks`
|Max status polling attempts +
Default: `20`

|`uploader.statusCheckDelay`
|Delay between status checks +
Default: `10 seconds`
|===

Generate tokens at https://central.sonatype.org/publish/generate-portal-token/[generate-portal-token]

== Tasks

Plugin registers tasks per publication and aggregation tasks:

=== Per-Publication Tasks

* `checksum<Publication>Publication` - Generate checksums
* `zipDeployment<Publication>Publication` - Create ZIP bundle
* `publish<Publication>PublicationToMavenCentralPortalRepository` - Upload bundle

=== Aggregation Tasks

* `checksumAllPublications` - Generate checksums for all publications
* `zipDeploymentAllPublications` - Bundle all publications
* `publishAllPublicationsToMavenCentralPortalRepository` - Upload all publications

=== Multi-Module Tasks

For root project with subprojects:

* `zipDeploymentAllModules` - Bundle all modules
* `publishAllModulesToMavenCentralPortalRepository` - Upload all modules

== Lifecycle Task Behavior

Plugin integrates with Gradle's `publish` lifecycle task:

=== Single-Module Projects

When root project has publications and no subprojects with publications:

[source,bash]
----
./gradlew publish
----

Executes: `publishAllPublicationsToMavenCentralPortalRepository`

=== Multi-Module Projects

When subprojects have publications:

[source,bash]
----
./gradlew publish
----

Executes: `publishAllModulesToMavenCentralPortalRepository`

Aggregates all publications from root and subprojects into single deployment bundle.

== Usage

=== Single Module

[source,kotlin]
----
publishing {
    repositories {
        mavenCentralPortal {
            credentials {
                username = sonatypeUser
                password = sonatypePassword
            }
        }
    }

    publications {
        create<MavenPublication>("mavenJava") {
            from(components["java"])

            pom {
                name = "My Library"
                description = "Library description"
                url = "https://github.com/user/repo"

                licenses {
                    license {
                        name = "Apache License 2.0"
                        url = "https://www.apache.org/licenses/LICENSE-2.0.txt"
                    }
                }

                developers {
                    developer {
                        id = "userid"
                        name = "User Name"
                        email = "user@example.com"
                    }
                }

                scm {
                    connection = "scm:git:git://github.com/user/repo.git"
                    developerConnection = "scm:git:ssh://github.com/user/repo.git"
                    url = "https://github.com/user/repo"
                }
            }
        }
    }
}

signing {
    val signingKey: String? by project
    val signingPassword: String? by project
    useInMemoryPgpKeys(signingKey, signingPassword)
    sign(publishing.publications)
}
----

[source,bash]
----
./gradlew publishAllPublicationsToMavenCentralPortalRepository
----

=== Multi-Module

Apply plugin to root and subprojects.
Root task aggregates all modules:

[source,bash]
----
./gradlew publishAllModulesToMavenCentralPortalRepository
----

== Requirements

* Gradle 8.0+
* Java 17+
* Valid Maven Central account
* POM metadata: name, description, url, licenses, developers, scm
* Signed artifacts

== Development

.Click to expand
[%collapsible]
=====
*CI/CD Pipeline*

The project uses GitHub Actions with workflows generated by https://github.com/typesafegithub/github-workflows-kt[github-workflows-kt].

Workflow source files (`.kts`) are located in `.github/workflows/`:

[cols="1,1,2"]
|===
|Source File |Generated YAML |Purpose

|`workflow.branch.main.kts`
|`build-on-branch.yml`
|Runs `check` on pull requests

|`workflow.main.main.kts`
|`build-on-main.yml`
|Creates version tag on push to `main` or `*.x` branches

|`workflow.release.main.kts`
|`release-on-tag.yml`
|Creates GitHub Release and publishes to Gradle Plugin Portal

|`workflow.labeler.main.kts`
|`labeler.yml`
|Automatically labels PRs based on changed file paths
|===

*Release Flow*

[source]
----
PR merge → check → create tag → [tag push] → release → publish
----

*Versioning via Commit Messages*

Version bumps are controlled by tokens in commit messages:

[cols="1,1,2"]
|===
|Token |Bump |Example

|`#major`
|X.0.0
|1.0.0 → 2.0.0 (Breaking changes)

|`#minor`
|0.X.0
|1.0.0 → 1.1.0 (New features)

|`#patch` or none
|0.0.X
|1.0.0 → 1.0.1 (Fixes, default)

|`#none`
|—
|Skip tag creation
|===

Example commit message:

[source]
----
feat: Add new authentication method #minor
----

*Regular Release*

. Create PR to `main`
. Merge with version token in commit message (or omit for patch)
. Pipeline automatically: check → tag → release → publish

*Creating Major Version (1.x → 2.x)*

When releasing breaking changes:

[source,bash]
----
# Create support branch for current version
git checkout main && git pull
git checkout -b 1.x
git push origin 1.x

# Return to main and merge PR with #major token
git checkout main
# Merge PR with commit message containing #major
# Auto-creates tag 2.0.0
----

*Backporting to Old Version*

[source,bash]
----
# Cherry-pick fix to support branch
git checkout 1.x && git pull
git cherry-pick <commit-hash>
git checkout -b fix/security-patch-1x
git push origin fix/security-patch-1x

# Create PR: fix/security-patch-1x → 1.x
# After merge: auto-creates tag 1.x.y → release → publish
----

*Rollback (before publish)*

[source,bash]
----
git push --delete origin 1.0.1
git tag -d 1.0.1
----

NOTE: Published versions cannot be deleted from Gradle Plugin Portal.

*Regenerating Workflows*

After modifying `.kts` files, regenerate YAML:

[source,bash]
----
./.github/workflows/workflow.main.main.kts
./.github/workflows/workflow.release.main.kts
./.github/workflows/workflow.branch.main.kts
./.github/workflows/workflow.labeler.main.kts
----

*Required Secrets*

[cols="1,2"]
|===
|Secret |Description

|`ZENHELIX_COMMITER_APP_ID`
|GitHub App ID for tag creation

|`ZENHELIX_COMMITER_APP_PRIVATE_KEY`
|GitHub App private key

|`GRADLE_PUBLISH_KEY`
|Gradle Plugin Portal publish key

|`GRADLE_PUBLISH_SECRET`
|Gradle Plugin Portal publish secret

|`MAVEN_SONATYPE_SIGNING_KEY_ID`
|GPG signing key ID

|`MAVEN_SONATYPE_SIGNING_KEY_ASCII_ARMORED`
|GPG private key (ASCII armored)

|`MAVEN_SONATYPE_SIGNING_PUB_KEY_ASCII_ARMORED`
|GPG public key (ASCII armored)

|`MAVEN_SONATYPE_SIGNING_PASSWORD`
|GPG key passphrase
|===
=====

== License

Licensed under the **Apache License, Version 2.0**.
For more details, see the link:LICENSE[LICENSE file] in the root of this repository.